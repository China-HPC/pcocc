.\" Man page generated from reStructuredText.
.
.TH "PCOCC-SAVE" "1" "Sep 05, 2017" "0.3.1" "pcocc"
.SH NAME
pcocc-save \- Save the disk of a VM
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.SH SYNOPSIS
.sp
pcocc save [OPTIONS] [VM]
.SH DESCRIPTION
.sp
Save the disk of a VM to a new disk image.
.sp
By default, only the differences between the current state of the VM disk and the image from which it was instantiated are saved in an incremental file to form a new revision of the image. When a VM is instantiated it uses the latest revision of the image defined in its template. Incremental save files are stored in the image directory and all incremental saves leading to the latest revision have to be kept. A user needs to have write permissions on the image directory to be able to create new revisions. New full and independant images can be saved using the \fB\-d\fP flag which creates a new image directory with the initial revision of the newly created image.
.sp
\fBWARNING:\fP
.INDENT 0.0
.INDENT 3.5
It is recommended to have the \fIqemu\-guest\-agent\fP package installed in the guest (see next section).
.UNINDENT
.UNINDENT
.SH RECOMMENDATIONS
.sp
Saving a running VM may lead to corruption if the filesystem is being accessed. To ensure a consistent filesystem image, pcocc tries to contact the Qemu guest agent in the VM to freeze the filesystems before creating a new image from this disk. Therefore, it is recommended to make sure that the qemu guest agent is running in the guest (see : pcocc\-newvm\-tutorial(7)).
.sp
If pcocc cannot contact the agent, it will emit a warning message but it will try to save the VM anyway. If installing the agent is not possible, you should freeze the filesystems by hand or simply shutdown your VM before calling pcocc save. In a Linux guest, you can use, as root \fIshutdown \-H now\fP to shutdown a VM without powering it off (as you want to keep your resource allocation).
.SH OPTIONS
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.TP
.B \-j, \-\-jobid INTEGER
Jobid of the selected cluster
.TP
.B \-J, \-\-jobname TEXT
Job name of the selected cluster
.TP
.B \-d, \-\-dest DIR
Make a full copy in a new directory
.TP
.B \-s, \-\-safe
Wait indefinitely for the Qemu agent to freeze filesystems
.TP
.B \-h, \-\-help
Show this message and exit.
.UNINDENT
.UNINDENT
.UNINDENT
.SH EXAMPLES
.sp
In these examples, we consider that the \fIqemu\-guest\-agent\fP is installed.
.SS Create a new image revision
.sp
If you have write permissions on the image directory used by your VMs, you can create new image revisions. For example to create a new revision of the image used by first VM of your virtual cluster use:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ pcocc save vm0
Saving image...
vm0 frozen
vm0 thawed
vm0 disk successfully saved to ./.pcocc/images/centos7\-cloud/image\-rev1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
A new file is created in the image directory
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ ls ./.pcocc/images/centos7\-cloud/image\-rev1
image  image\-rev1
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The next VM instantiated with this image will use the new revision. You can undo saves by removing the latest revisions. However removing an intermediate revision will corrupt all subsequent revisions.
.SS Create a new independent images
.sp
If you want to create a new full image or do not have write permissions on the image directory use by your VM you can to use the "\-d" flag to save to an VM image in a new directory:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
$ pcocc save vm0 \-d $HOME/my\-centos7
Saving image...
vm0 frozen
vm0 thawed
Merging snapshot with backing file to make it standalone...
vm0 disk successfully saved to /home/user/my\-centos7/image
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can now create a template inheriting from the original one, but using the new image image, by editing your \fBtemplates.yaml\fP file:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
mycentos:
    inherits: centos7\-cloud
    image: ~/my\-centos7/
.ft P
.fi
.UNINDENT
.UNINDENT
.SH SEE ALSO
.sp
pcocc\-templates.yaml(5), pcocc\-newvm\-tutorial(7), pcocc\-ckpt(1), pcocc\-dump(1)
.SH AUTHOR
François Diakhaté
.SH COPYRIGHT
2017
.\" Generated by docutils manpage writer.
.
